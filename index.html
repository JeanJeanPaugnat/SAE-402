<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
    <script src="./src/components/ar-hit-test.js"></script>
    <script src="./src/components/ar-spawner.js"></script>
    <script src="./src/components/hand-grab.js"></script>
    <script src="./src/components/real-world-physics.js"></script>
  </head>
  <body>
    <a-scene 
      physics="driver: local; gravity: -9.8; restitution: 0.6; friction: 0.3"
      webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay, bounded-floor, hand-tracking, plane-detection, mesh-detection; overlayElement: #overlay; referenceSpaceType: local-floor;"
      renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true"
      background="color: transparent"
      vr-mode-ui="enterARButton: #ar-button; enterVRButton: false"
      cursor="rayOrigin: mouse">
      
      <!-- ============ ASSETS (préchargement) ============ -->
      <a-assets>
        <a-asset-item id="coffee-machine-model" src="./models/Coffee Machine.glb"></a-asset-item>
        <a-asset-item id="coffee-cup-model" src="./models/Coffee cup.glb"></a-asset-item>
      </a-assets>

      <!-- Lumières -->
      <a-light type="directional" position="-1 2 1" intensity="1"></a-light>
      <a-light type="ambient" intensity="0.5"></a-light>

      <!-- Sol invisible avec physique (pour que les objets ne tombent pas indéfiniment) -->
      <a-plane static-body 
               position="0 0 0" 
               rotation="-90 0 0" 
               width="20" 
               height="20" 
               visible="false">
      </a-plane>

      <!-- Manettes Quest (grip/trigger pour attraper) -->
      <a-entity id="left-controller" 
                oculus-touch-controls="hand: left" 
                controller-grab="hand: left">
      </a-entity>
      <a-entity id="right-controller" 
                oculus-touch-controls="hand: right" 
                controller-grab="hand: right">
      </a-entity>


      <!-- Cube attrapable (à 1m devant toi, hauteur de table) -->
      <a-box dynamic-body="mass: 1; linearDamping: 0.1; angularDamping: 0.1" 
             id="debug-cube" 
             position="0 0.8 -0.5" 
             scale="0.1 0.1 0.1" 
             material="color: lime; shader: flat"
             grabbable>
      </a-box>

      <!-- Sphère rebondissante -->
      <a-sphere dynamic-body="mass: 0.5; linearDamping: 0.05" 
                id="bouncy-ball" 
                position="0.3 1.2 -0.7" 
                radius="0.05" 
                material="color: #FF6B6B; metalness: 0.3; roughness: 0.4"
                grabbable>
      </a-sphere>

      <!-- Petit cube rouge -->
      <a-box dynamic-body="mass: 0.8" 
             id="red-cube" 
             position="-0.2 1.0 -0.6" 
             scale="0.08 0.08 0.08" 
             material="color: #E74C3C; shader: flat"
             grabbable>
      </a-box>

      <!-- ============ MODÈLES 3D ============ -->
      
      <!-- Machine à café (statique, posée) -->
      <a-entity id="coffee-machine" 
                gltf-model="#coffee-machine-model"
                position="0 0.5 -1"
                scale="0.3 0.3 0.3"
                rotation="0 0 0">
      </a-entity>

      <!-- Tasse de café (attrapable avec physique) -->
      <a-entity id="coffee-cup" 
                gltf-model="#coffee-cup-model"
                dynamic-body="shape: box; mass: 0.3"
                position="0.25 0.65 -0.8"
                scale="0.15 0.15 0.15"
                rotation="0 0 0"
                grabbable>
      </a-entity>

      <!-- ============ OBSTACLES / MURS (MODE DEBUG - désactivé en AR) ============ -->
      <!-- 
        En réalité mixte sur Quest 3, ces murs virtuels sont remplacés par 
        le Scene Mesh (les vraies surfaces de ta pièce).
        Garde-les pour tester sur desktop, commente-les pour le Quest.
      -->
      
      <!-- DEBUG: Mur arrière (décommenter pour tester sur desktop) -->
      <!--
      <a-box static-body 
             class="debug-wall"
             position="0 1 -2" 
             scale="4 3 0.1" 
             material="color: #3498DB; opacity: 0.3; transparent: true">
      </a-box>
      -->

      <!-- DEBUG: Mur gauche -->
      <!--
      <a-box static-body 
             class="debug-wall"
             position="-1.5 1 -1" 
             scale="0.1 3 2" 
             material="color: #9B59B6; opacity: 0.3; transparent: true">
      </a-box>
      -->

      <!-- DEBUG: Mur droit -->
      <!--
      <a-box static-body 
             class="debug-wall"
             position="1.5 1 -1" 
             scale="0.1 3 2" 
             material="color: #1ABC9C; opacity: 0.3; transparent: true">
      </a-box>
      -->

      <!-- Gestionnaire de physique monde réel -->
      <a-entity ar-plane-collider="showDebugPlanes: true"></a-entity>

      <!-- 
        DEBUG: Table virtuelle (désactiver pour utiliser une vraie table)
        En AR, les objets reposeront sur les vraies surfaces détectées.
      -->
      <!--
      <a-box static-body 
             id="table" 
             position="0 0.4 -1" 
             scale="0.8 0.05 0.5" 
             material="color: #8B4513">
      </a-box>
      <a-box position="-0.35 0.2 -0.75" scale="0.05 0.4 0.05" material="color: #654321"></a-box>
      <a-box position="0.35 0.2 -0.75" scale="0.05 0.4 0.05" material="color: #654321"></a-box>
      <a-box position="-0.35 0.2 -1.25" scale="0.05 0.4 0.05" material="color: #654321"></a-box>
      <a-box position="0.35 0.2 -1.25" scale="0.05 0.4 0.05" material="color: #654321"></a-box>
      -->

      <!-- Cylindre obstacle virtuel (optionnel - garde si tu veux un obstacle virtuel) -->
      <a-cylinder static-body 
                  id="virtual-obstacle"
                  position="0.5 0.6 -0.8" 
                  radius="0.08" 
                  height="0.3" 
                  material="color: #F39C12">
      </a-cylinder>

      <!-- Réticule de placement (suit les surfaces détectées) -->
      <!-- <a-entity id="reticle" ar-hit-test="target: #coffee-machine" visible="false">
        <a-ring radius-inner="0.04" radius-outer="0.06" 
                rotation="-90 0 0"
                material="color: white; opacity: 0.8; transparent: true; shader: flat">
        </a-ring>
        <a-ring radius-inner="0.01" radius-outer="0.015" 
                rotation="-90 0 0"
                material="color: white; shader: flat">
        </a-ring>
      </a-entity> -->



    </a-scene>

    <!-- Overlay HTML pour l'interface 2D (optionnel) -->
    <div id="overlay" style="display: none;"></div>

    <!-- Bouton AR personnalisé pour Quest 3 -->
    <button id="ar-button" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 30px; font-size: 18px; background: #4CC3D9; border: none; border-radius: 10px; cursor: pointer; z-index: 9999;">
      Entrer en Réalité Mixte
    </button>

    <script>
      // Attendre que la scène soit prête
      document.querySelector('a-scene').addEventListener('loaded', () => {
        console.log('✅ Scène A-Frame chargée');
      });

      // Script pour forcer le mode AR (passthrough) sur Quest 3
      document.getElementById('ar-button').addEventListener('click', async () => {
        const sceneEl = document.querySelector('a-scene');
        
        if (navigator.xr) {
          // Vérifier si immersive-ar est supporté
          const arSupported = await navigator.xr.isSessionSupported('immersive-ar');
          console.log('AR supporté:', arSupported);
          
          if (arSupported) {
            // Utiliser la méthode native d'A-Frame pour entrer en AR
            sceneEl.enterAR();
            document.getElementById('ar-button').style.display = 'none';
          } else {
            alert('Le mode AR n\'est pas supporté sur cet appareil');
          }
        } else {
          alert('WebXR non disponible');
        }
      });
    </script>
  </body>
</html>