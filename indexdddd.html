<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>‚òï Coffee Cup AR - SAE 402</title>
  <link rel="stylesheet" href="src/style.css">
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <!-- Physics system avec CANNON.js -->
  <script
    src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>

  <!-- Composants externes -->
  <script src="./src/components/hand-grab.js"></script>
  <script src="./src/components/real-world-physics.js"></script>
  <script src="./src/components/ar-plane-detection.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #info {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 1000;
      max-width: 320px;
    }

    #info h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
    }

    #info p {
      margin: 5px 0;
      font-size: 14px;
    }

    #count {
      color: #4CC3D9;
      font-weight: bold;
    }

    #debug {
      font-size: 12px;
      color: #FFD700;
      margin-top: 10px;
      font-family: monospace;
    }

    #start-ar-btn {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 18px 40px;
      font-size: 20px;
      font-weight: bold;
      background: linear-gradient(135deg, #4CC3D9, #3498db);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    #start-ar-btn:hover {
      transform: translateX(-50%) scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
  </style>
</head>

<body>
  <!-- Interface HTML visible sur l'√©cran -->
  <div id="info">
    <h2>‚òï Coffee Cup AR</h2>
    <p>Utilisez votre espace r√©el configur√© !</p>
    <p><strong>A</strong> : Spawner tasse | <strong>Grip</strong> : Attraper</p>
    <p id="count">Tasses plac√©es: 0</p>
    <p id="debug">√âtat: Pr√™t</p>
  </div>

  <button id="start-ar-btn">ü•Ω D√©marrer en AR</button>

  <!-- Sc√®ne A-Frame -->
  <!-- IMPORTANT: Disable autoCapture to use existing room setup -->
  <!-- Add plane-detection, mesh-detection to optionalFeatures -->
  <a-scene
    webxr="requiredFeatures: local-floor, hit-test; optionalFeatures: anchors, hand-tracking, plane-detection, mesh-detection; referenceSpaceType: local-floor;"
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true; physicallyCorrectLights: true; alpha: true; antialias: true"
    background="color: transparent" physics="driver: local; gravity: -9.8; debug: false" ar-session-manager
    ar-plane-detection="visualizePlanes: true; autoCapture: false" real-world-physics="enablePhysics: true"
    ar-plane-collider>

    <!-- ============ ASSETS ============ -->
    <a-assets>
      <a-asset-item id="coffee-cup-model" src="./public/models/Coffee cup.glb"></a-asset-item>
    </a-assets>

    <!-- ============ √âCLAIRAGE ============ -->
    <a-light type="ambient" intensity="0.7"></a-light>
    <a-light type="directional" position="1 2 1" intensity="0.9" cast-shadow="true"></a-light>

    <!-- ============ CAM√âRA ============ -->
    <a-camera position="0 1.6 0">
      <a-text id="vr-debug-text" value="Pr√™t" position="0 0.35 -1" scale="0.4 0.4 0.4" color="#00FF00" align="center"
        material="shader: flat"></a-text>
    </a-camera>

    <!-- ============ CONTROLEURS ============ -->
    <!-- Contr√¥leur gauche: Main ou Manette -->
    <a-entity id="left-hand" hand-tracking-controls="hand: left; modelStyle: mesh; modelColor: #4CC3D9"
      hand-grab="hand: left">
      <a-sphere radius="0.02" color="#4CC3D9" material="opacity: 0.3; transparent: true"></a-sphere>
    </a-entity>
    <a-entity id="left-controller" oculus-touch-controls="hand: left" controller-grab="hand: left"></a-entity>

    <!-- Contr√¥leur droit: Main ou Manette + Spawner -->
    <a-entity id="right-hand" hand-tracking-controls="hand: right; modelStyle: mesh; modelColor: #4CC3D9"
      hand-grab="hand: right">
      <a-sphere radius="0.02" color="#4CC3D9" material="opacity: 0.3; transparent: true"></a-sphere>
    </a-entity>
    <a-entity id="right-controller" oculus-touch-controls="hand: right" controller-grab="hand: right"
      cup-spawner></a-entity>

  </a-scene>

  <!-- ============ MANAGER DE SESSION ============ -->
  <script>
    AFRAME.registerComponent('ar-session-manager', {
      init: function () {
        this.startBtn = document.querySelector('#start-ar-btn');
        this.setupButton();
        this.el.sceneEl.addEventListener('enter-vr', () => this.startBtn.style.display = 'none');
        this.el.sceneEl.addEventListener('exit-vr', () => this.startBtn.style.display = 'block');
      },
      setupButton: function () {
        const self = this;
        this.startBtn.addEventListener('click', async () => {
          // Utilisation du binding WebXR standard d'A-Frame
          // On appelle enterVR() qui utilise la config de la sc√®ne
          try {
            await self.el.sceneEl.enterVR();
          } catch (e) {
            console.error("Erreur enterVR:", e);
            alert("Erreur WebXR:" + e.message);
          }
        });
      }
    });

    /**
     * Composant simple pour spawner des tasses
     */
    AFRAME.registerComponent('cup-spawner', {
      schema: { cupScale: { type: 'number', default: 0.1 } },
      init: function () {
        this.el.addEventListener('abuttondown', this.spawnCup.bind(this));

        // Si on utilise le tracking des mains, on peut ajouter un geste ici plus tard
        console.log('‚òï Spawner pr√™t - Appuyez sur A');
      },
      spawnCup: function () {
        // Position devant la manette
        const pos = new THREE.Vector3(0, 0.1, -0.2);
        pos.applyMatrix4(this.el.object3D.matrixWorld);

        const rot = this.el.object3D.quaternion.clone();

        const cup = document.createElement('a-entity');
        cup.setAttribute('gltf-model', '#coffee-cup-model');
        const s = this.data.cupScale;
        cup.setAttribute('scale', `${s} ${s} ${s}`);
        cup.setAttribute('position', pos);
        cup.setAttribute('quaternion', rot); // Rotation initiale

        // Rendre grabbable
        cup.setAttribute('grabbable', '');

        // Physique DYNAMIQUE pour qu'elle tombe
        // On attend que le mod√®le soit charg√© pour la bounding box correcte
        cup.addEventListener('model-loaded', () => {
          cup.setAttribute('dynamic-body', {
            mass: 0.5,
            shape: 'hull', // Plus pr√©cis que 'box' pour une tasse
            linearDamping: 0.2,
            angularDamping: 0.2
          });

          cup.setAttribute('physics-material', {
            restitution: 0.3, // Rebond mod√©r√©
            friction: 0.7     // Reste bien sur la table
          });
        });

        this.el.sceneEl.appendChild(cup);
        console.log('Tasse spawn√©e!');

        // Update compteur (optionnel)
        const countEl = document.querySelector('#count');
        if (countEl) {
          const current = parseInt(countEl.textContent.replace(/[^0-9]/g, '')) || 0;
          countEl.textContent = `Tasses plac√©es: ${current + 1}`;
        }
      }
    });
  </script>
</body>

</html>