<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AR Plane Detection - Quest 3</title>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <script src="./components/ar-plane-detection.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Segoe UI', Arial, sans-serif;
        z-index: 1000;
        max-width: 350px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      #info h2 { 
        margin: 0 0 15px 0; 
        font-size: 20px;
        border-bottom: 2px solid #4CC3D9;
        padding-bottom: 10px;
      }
      #info p { 
        margin: 8px 0; 
        font-size: 14px;
        line-height: 1.5;
      }
      .status {
        background: rgba(76, 195, 217, 0.2);
        padding: 8px;
        border-radius: 4px;
        margin-top: 10px;
        border-left: 3px solid #4CC3D9;
      }
      .legend {
        font-size: 12px;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #444;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
      }
      .color-box {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border-radius: 3px;
        border: 1px solid #fff;
      }
      #capture-btn {
        margin-top: 15px;
        padding: 10px 20px;
        background: #4CC3D9;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        width: 100%;
        font-weight: bold;
      }
      #capture-btn:hover {
        background: #3BA8C0;
      }
      #capture-btn:disabled {
        background: #666;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div id="info">
      <h2>ðŸ”· DÃ©tection de Plans AR</h2>
      <p><strong>Instructions:</strong></p>
      <p>1. Cliquez sur "Enter AR"</p>
      <p>2. Configurez votre espace Guardian si ce n'est pas fait</p>
      <p>3. Les plans (murs, sols, meubles) apparaÃ®tront automatiquement</p>
      
      <div class="status">
        <p id="plane-count" style="margin: 0; font-weight: bold;">Plans dÃ©tectÃ©s: 0</p>
      </div>

      <div class="legend">
        <p style="margin: 0 0 8px 0; font-weight: bold;">LÃ©gende:</p>
        <div class="legend-item">
          <div class="color-box" style="background: #4CC3D9;"></div>
          <span>Plans horizontaux (sol, table)</span>
        </div>
        <div class="legend-item">
          <div class="color-box" style="background: #FFC65D;"></div>
          <span>Plans verticaux (murs)</span>
        </div>
      </div>

      <button id="capture-btn" onclick="triggerCapture()">
        ðŸŽ¯ Configurer l'espace
      </button>

      <p id="debug" style="font-size: 11px; color: #FFD700; margin-top: 15px;">Debug: PrÃªt</p>
    </div>

    <a-scene 
      webxr="requiredFeatures: plane-detection, local-floor;"
      vr-mode-ui="enabled: false"
      ar-plane-detection="visualizePlanes: true; autoCapture: true; waitTime: 3000">
      
      <!-- CamÃ©ra AR -->
      <a-camera position="0 1.6 0">
        <!-- Panneau de debug dans le casque -->
        <a-text 
          id="debug-text" 
          value="Cherche des plans..." 
          position="0 0.5 -1.5" 
          scale="0.8 0.8 0.8" 
          color="#00FF00" 
          align="center"
          width="2">
        </a-text>

        <!-- Compteur de plans dans le casque -->
        <a-text 
          id="plane-count-vr" 
          value="Plans: 0" 
          position="0 0.3 -1.5" 
          scale="0.6 0.6 0.6" 
          color="#4CC3D9" 
          align="center">
        </a-text>

        <!-- Instructions dans le casque -->
        <a-text 
          value="Regardez autour de vous&#10;Les plans seront dÃ©tectÃ©s automatiquement" 
          position="0 -0.3 -1.5" 
          scale="0.4 0.4 0.4" 
          color="#FFFFFF" 
          align="center"
          width="3">
        </a-text>
      </a-camera>

      <!-- LumiÃ¨re ambiante -->
      <a-light type="ambient" color="#BBB"></a-light>
      <a-light type="directional" color="#FFF" intensity="0.6" position="-0.5 1 1"></a-light>

      <!-- Sol de rÃ©fÃ©rence (invisible en AR mais utile pour le dÃ©veloppement) -->
      <a-plane 
        position="0 0 0" 
        rotation="-90 0 0" 
        width="10" 
        height="10" 
        color="#7BC8A4" 
        shadow="receive: true"
        visible="false">
      </a-plane>
    </a-scene>

    <script>
      // Fonction pour dÃ©clencher manuellement la capture
      function triggerCapture() {
        const scene = document.querySelector('a-scene');
        const planeDetection = scene.components['ar-plane-detection'];
        
        if (planeDetection) {
          planeDetection.triggerRoomCapture();
          document.querySelector('#capture-btn').disabled = true;
          document.querySelector('#capture-btn').textContent = 'â³ Configuration lancÃ©e...';
        } else {
          alert('Entrez d\'abord en mode AR');
        }
      }

      // Mettre Ã  jour l'interface utilisateur
      const scene = document.querySelector('a-scene');
      
      scene.addEventListener('enter-vr', () => {
        console.log('ðŸŽ® Mode AR activÃ©');
        document.querySelector('#debug').textContent = 'Debug: Mode AR actif';
        document.querySelector('#capture-btn').disabled = false;
        document.querySelector('#capture-btn').textContent = 'ðŸŽ¯ Configurer l\'espace';
      });

      scene.addEventListener('exit-vr', () => {
        console.log('ðŸ‘‹ Mode AR dÃ©sactivÃ©');
        document.querySelector('#debug').textContent = 'Debug: Mode AR dÃ©sactivÃ©';
        document.querySelector('#plane-count').textContent = 'Plans dÃ©tectÃ©s: 0';
      });

      // Mise Ã  jour continue du compteur de plans
      setInterval(() => {
        const session = scene.renderer?.xr?.getSession();
        if (session && session.detectedPlanes) {
          const count = session.detectedPlanes.size;
          document.querySelector('#plane-count').textContent = `Plans dÃ©tectÃ©s: ${count}`;
          
          const planeCountVR = document.querySelector('#plane-count-vr');
          if (planeCountVR) {
            planeCountVR.setAttribute('value', `Plans: ${count}`);
          }

          // Mettre Ã  jour le texte de debug dans le casque
          const debugTextVR = document.querySelector('#debug-text');
          if (debugTextVR) {
            if (count === 0) {
              debugTextVR.setAttribute('value', 'Cherche des plans...');
              debugTextVR.setAttribute('color', '#FFD700');
            } else {
              debugTextVR.setAttribute('value', `${count} plan${count > 1 ? 's' : ''} trouvÃ©${count > 1 ? 's' : ''} !`);
              debugTextVR.setAttribute('color', '#00FF00');
            }
          }
        }
      }, 500);
    </script>
  </body>
</html>
